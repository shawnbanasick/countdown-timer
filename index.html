<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="apple-mobile-web-app-title" content="EQ Mobile" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <!-- <meta
      name="viewport"
      content="viewport-fit=cover, user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    /> -->
    <meta
      name="viewport"
      content="viewport-fit=cover, width=device-width, user-scalable=no, initial-scale=1"
    />

    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Countdown Timer</title>

    <script src="src/jquery-3.6.0.min.js"></script>
    <script src="src/jquery.fittext.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
      integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="stylesheets/jquery.mobile-1.4.5.css" />
    <link
      rel="stylesheet"
      href="stylesheets/stylesheet.css"
      type="text/css"
      charset="utf-8"
    />
    <link rel="stylesheet" href="custom.css" />

    <!--    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?" />
    <link rel="apple-touch-icon" sizes="152x152" href="touch-icon-ipad.png" />

    <link
      rel="apple-touch-icon"
      sizes="167x167"
      href="touch-icon-ipad-retina.png"
    /> -->

    <!-- iPad Pro 12.9" (2048px x 2732px) 
    <link
      rel="apple-touch-startup-image"
      media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"
      href="/apple-launch-2048x2732.png" 
    /> -->

    <!-- iPad Pro 11” (1668px x 2388px) 
    <link
      rel="apple-touch-startup-image"
      media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"
      href="/apple-launch-1668x2388.png" 
    /> -->

    <!-- iPad Pro 10.5" (1668px x 2224px) 
    <link
      rel="apple-touch-startup-image"
      media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)"
      href="/apple-launch-1668x2224.png"
    /> -->

    <!-- <link rel="manifest" href="eq-mobile.webmanifest" />
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("/eq-mobile/sw.js").then(
            function (registration) {
              // Registration was successful
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            },
            function (err) {
              // registration failed :(
              console.log("ServiceWorker registration failed: ", err);
            }
          );
        });
      }
    </script>  -->
  </head>

  <body>
    <div class="container">
      <div class="leftContainer">
        <label class="inputLabel" for="totalTime">Time:</label>
        <input id="totalTime" />
        <div class="buttonsHolder">
          <button class="btn" id="goButton">Start</button>
          <button class="btn" id="stopButton">Stop</button>
        </div>
        <label class="inputLabel" for="yellowTime">Yellow at:</label>
        <input value="10" id="yellowTime" />
        <label class="inputLabel" for="orangeTime">Orange at:</label>
        <input value="5" id="orangeTime" />
        <div class="seconds"></div>
      </div>
      <div class="rightContainer">
        <span class="digital">0</span>
      </div>
    </div>
    <script>
      $(document).ready(function () {
        let time;
        let tmp;
        let digit = $(".digital");
        let counter;
        let sec;
        let yellowAt;
        let orangeAt;

        // adjust text size with library
        digit.fitText(0.14);

        // test for wakelock
        if ("wakeLock" in navigator) {
          console.log("wake lock supported");
        }

        // The wake lock sentinel.
        let wakeLock = null;

        // Function that attempts to request a screen wake lock.
        const requestWakeLock = async () => {
          try {
            wakeLock = await navigator.wakeLock.request();
            wakeLock.addEventListener("release", () => {
              console.log("Screen Wake Lock released:", wakeLock.released);
            });
            console.log("Screen Wake Lock released:", wakeLock.released);
          } catch (err) {
            console.error(`${err.name}, ${err.message}`);
          }
        };

        // Request a screen wake lock…
        requestWakeLock();

        // …and release it again after 5s.
        window.setTimeout(() => {
          wakeLock.release();
          wakeLock = null;
        }, 5000);

        // timer LOOPED
        function myTimer() {
          var c = tmp--,
            m = (c / 60) >> 0;

          if (tmp === 0) {
            $("body").css("background-color", "red");
            $(".digital").css("color", "black");
            $(".btn").removeClass("btnOrange").addClass("btnRed");
            $(".seconds").css("color", "black");
            $("input").css("background-color", "red");
            $("input").css("color", "black");
            $("input").css("border", "2px solid black");
            $("#goButton").css("background-color", "red");
            $("#stopButton").css("background-color", "red");
            $(".inputLabel").css("color", "black");
          }

          // send to display
          digit.text(m);
          sec.text(tmp);

          // Yellow at user specified time (if indicated)
          if (tmp - 58 === yellowAt && yellowAt !== 0) {
            $("body").css("background-color", "#FFCC00");
            $("input").css("background-color", "#FFCC00");
            $("input").css("color", "black");
            $("input").css("border", "2px solid black");
            $(".digital").css("color", "black");
            $(".inputLabel").css("color", "black");
            $(".btn").removeClass("btn").addClass("btnYellow");
            $(".seconds").css("color", "black");
          }

          // Orange at user specified time (if indicated)
          if (tmp - 58 === orangeAt && orangeAt !== 0) {
            $("body").css("background-color", "#ff7b00");
            $("input").css("background-color", "#ff7b00");
            $("input").css("color", "black");
            $(".digital").css("color", "black");
            $(".inputLabel").css("color", "black");
            $(".btn").removeClass("btnYellow").addClass("btnOrange");
            $("#goButton").css("background-color", "#ff7b00");
            $("#stopButton").css("background-color", "#ff7b00");
            $(".seconds").css("color", "black");
          }

          // failsafe
          if (tmp <= -3600) {
            clearInterval(counter);
            wakeLock.release();
            wakeLock = null;
          }
        }

        // get references
        let $totalTime = $("#totalTime");
        let $yellowTime = $("#yellowTime");
        let $orangeTime = $("#orangeTime");

        // set totalTime to stored time
        let storedTime = +localStorage.getItem("totalTime") || "";
        $totalTime.val(storedTime);
        // listen for changes in total time
        $totalTime.change(function () {
          localStorage.setItem("totalTime", $(this).val());
        });

        // set yellowTime to stored time
        let storedYellowTime = +localStorage.getItem("yellowTime") || "";
        $yellowTime.val(storedYellowTime);
        // listen for changes in total time
        $yellowTime.change(function () {
          localStorage.setItem("yellowTime", $(this).val());
        });

        // set orangeTime to stored time
        let storedOrangeTime = +localStorage.getItem("orangeTime") || "";
        $orangeTime.val(storedOrangeTime);
        // listen for changes in total time
        $orangeTime.change(function () {
          localStorage.setItem("orangeTime", $(this).val());
        });

        // stop button
        $("#stopButton").click(function () {
          clearInterval(counter);
          document.location.reload();
        });

        // start button
        $("#goButton").click(function () {
          if (counter) {
            clearInterval(counter);
          }
          let input = +localStorage.getItem("totalTime");
          time = input * 60;
          tmp = time;
          sec = $(".seconds");
          yellowAt = +localStorage.getItem("yellowTime") * 60;
          orangeAt = +localStorage.getItem("orangeTime") * 60;
          counter = setInterval(myTimer, 1000);
        });
      });
    </script>
  </body>
</html>
